define(["Sprite3D","../app/pageInfo","TweenMax"],function(a,b,c){function d(a,b){this.superclass.call(this,a[0]),this.divElement=a,this.setPageInfo(b)}function e(a,b){a.prototype=new b,a.prototype.constructor=a,a.prototype.superclass=b,a.prototype.superproto=b.prototype}e(d,a),d.prototype.divElement={},d.prototype.contentSprite3D={},d.prototype.initProps={},d.prototype.elementList=[],d.prototype.sectionsList=[],d.prototype.title=null,d.prototype.bg=null,d.prototype.client=null,d.prototype.redLine=null,d.prototype.textPlane=null,d.prototype.content=null,d.prototype.textPlane=null,d.prototype.free3DContainer=null,d.prototype.twFadeIn=null,d.prototype.twFadeOut=null,d.prototype.isBuilt=!1,d.prototype.video=null,d.prototype.pictoPlay=null,d.prototype.projectPlayer=null,d.prototype.secondaryElements=[],d.prototype.currentDatePanel=null,d.prototype.setPageInfo=function(a){return this.pageInfo=a,this.build(),this},d.prototype.getPageInfo=function(){return this.pageInfo},d.prototype.playVideo=function(a){var b=a.currentTarget.self;c.to(b.videoContainer,.5,{delay:.2,autoAlpha:1}),b.projectPlayer.setCSS("visibility","visible"),c.to(b.pictoPlay.domElement,.5,{autoAlpha:0}),b.video.play()},d.prototype.openDatePanel=function(a){var b=a.currentTarget.self,d=a.currentTarget;b.closeDatePanel();var e=b.getOpenPanel(d.id),f=e.element3d,g=e.info;$(f.domElement).on("click",function(){b.closeDatePanel()});var h=f.y;c.fromTo(f,.2,{rotationX:60,y:h+50},{rotationX:0,y:h,onUpdate:function(a){a.update()},onUpdateParams:[f],ease:Power3.easeOut}),c.to(f.domElement,.2,{autoAlpha:1,onStartParams:[f,g,b],onStart:b.addChildAsSecondary}),c.to(d,.1,{autoAlpha:0}),b.currentDatePanel=d},d.prototype.getOpenPanel=function(a){var b=a.replace("p_","div_"),c=b+"_open";return this.getSecondaryObj(c)},d.prototype.getSecondaryObj=function(a){for(var b=0;b<this.secondaryElements.length;b++)if(this.secondaryElements[b].id==a)return this.secondaryElements[b]},d.prototype.closeDatePanel=function(a){if(null==a){if(null==this.currentDatePanel)return;a=this.currentDatePanel}var b=this.getOpenPanel(a.id);c.to(a,.3,{autoAlpha:1});var d=b.element3d,e=d.y;c.to(d.domElement,.25,{autoAlpha:0,ease:Power2.easeOut}),c.to(d,.25,{y:e-80,rotationX:-60,onUpdate:function(a){a.update()},onUpdateParams:[d],onComplete:function(a,b){a.y=b},onCompleteParams:[d,e],ease:Power2.easeOut})},d.prototype.onClickVideo=function(a){var b=a.currentTarget;b.paused?b.self.resumeVideo():b.self.pauseVideo()};var f;d.prototype.onTouchStartPicto=function(a){},d.prototype.onTouchStartVideo=function(a){f=a.target},d.prototype.onTouchEndVideo=function(a){a.target==f&&a.currentTarget.self.onClickVideo(a)},d.prototype.preloadVideo=function(){for(var a=0;a<this.secondaryElements.length;a++)"div_player"==this.secondaryElements[a].id&&(this.projectPlayer=this.secondaryElements[a].element3d,this.projectPlayer.addClassName("project-player"),this.videoContainer=this.projectPlayer.domElement),"button_playButton"==this.secondaryElements[a].id&&(this.pictoPlay=this.secondaryElements[a].element3d);this.videoContainer&&(this.videoContainer.innerHTML='<video id="project-video"><source src="https://vod.infomaniak.com/redirect/silvremarchal_1_vod/raw-12978/mp4-32/'+this.pageInfo.id+'.mp4" type="video/mp4"><source src="https://vod.infomaniak.com/redirect/silvremarchal_1_vod/raw-12978/webm-32/'+this.pageInfo.id+'.webm" type="video/webm"></video>',this.video=this.videoContainer.firstElementChild,this.videoContainer.self=this,this.video.self=this,this.video.addEventListener("click",this.onClickVideo),this.video.addEventListener("touchstart",this.onTouchStartVideo),this.video.addEventListener("touchend",this.onTouchEndVideo)),this.resize()},d.prototype.resumeVideo=function(){this.video&&(this.video.play(),this.video.className=this.video.className.replace("pause-video",""))},d.prototype.pauseVideo=function(){this.video&&(this.video.pause(),this.video.className+=" pause-video ")},d.prototype.removeVideo=function(){this.videoContainer&&this.video&&(this.video.pause(),this.video.removeEventListener("click",this.onClickVideo),this.video.removeEventListener("touchstart",this.onTouchStartVideo),this.video.removeEventListener("touchend",this.onTouchEndVideo),this.videoContainer.innerHTML="",c.to(this.videoContainer,.3,{autoAlpha:0,onComplete:function(a){a.projectPlayer.setCSS("visibility","hidden")},onCompleteParams:[this]}),c.to(this.pictoPlay.domElement,.3,{autoAlpha:1}))},d.prototype.resize=function(){if(this.projectPlayer){var a=LAYOUT.viewportW/1280,b=LAYOUT.viewportH/720,d=a>b?a:b,e=Math.round(1280*d*.55),f=Math.round(720*d*.55);c.set(this.projectPlayer.domElement,{width:e,height:f}),c.set(this.video,{width:e-20,height:f-20})}};var g=function(a,b){return a.className+=" "+b+" ",a};return d.prototype.build=function(){this.secondaryElements=[],this.elementList=[];var a=UTILS.clone(this.pageInfo.layout);if(null!=this.pageInfo.images)for(var c in this.pageInfo.images)a["img_"+c]=this.pageInfo.images[c];for(var d in a){var e=d;if("id"!=e&&"grid"!=e){var f,h,i=a[d],j={info:i,id:e};-1==e.search("_")?(h=e,f=this.divElement.children(h)[0]):(h=e.split("_"),f=this.divElement.children(h[0]+"[id3d*='"+h[1]+"']")[0]);var k;f?(null!=i.wrapLeftOffset&&(f=wrapText(f,i.width,i.wrapLeftOffset)),k=this.convertElement(f,i)):k=this.createElement(h[0],h[1],i),j.element3d=k,k.setId(e),i.position!=b.FREE3D_P?i.secondary||this.addChild(k):k.setRotateFirst(!1),i.sectionId&&(k.sectionId=i.sectionId,this.sectionsList.push(k)),null!=i.clickHandler&&(k.domElement.addEventListener("click",this[i.clickHandler]),k.domElement.addEventListener("touchstart ",this[i.clickHandler]),k.domElement.self=this),i.secondary&&this.secondaryElements.push(j),null!=i.className&&g(k.domElement,i.className),null!=i.opacity&&k.setOpacity(i.opacity),null!=i.visibility&&k.setCSS("visibility",i.visibility),k.update(),this.elementList.push(j)}}return this.setCSS("opacity","0"),this.setCSS("visibility","hidden"),this.resize(),this.isBuilt=!0,this},wrapText=function(a,b,c){var d=document.createElement("div");return d.setAttribute("style","-webkit-transform-style : preserve-3d; transform-style: preserve-3d; position:fixed; left:"+c+"px; width:"+b+"px ;"),d.appendChild(a),c>0&&UTILS.shapeWrapper(15,"7.5,5,159|22.5,11,152|37.5,18,146|52.5,24,139|67.5,30,133|82.5,37,126|97.5,43,119|112.5,49,113|127.5,55,106|142.5,62,100|157.5,68,93|172.5,74,86|187.5,81,80|202.5,87,73|217.5,93,66|232.5,100,60|247.5,106,53|262.5,112,47|277.5,118,40|292.5,125,33|307.5,0,0|322.5,0,0|",d,20),d},d.prototype.isHidden=function(){var a=!this.isBuilt||"hidden"==this.getCSS("visibility");return a},d.prototype.secElementsAdded=!1,d.prototype.addSecondaryElements=function(){if(!this.secElementsAdded){for(var a=0;a<this.secondaryElements.length;a++){var b=this.secondaryElements[a],d=b.info,e=b.element3d;if(e.setCSS("opacity","0"),e.setCSS("visibility","hidden"),d.secondary.stayHidden)this.addChildAsSecondary(e,d,this);else{var f=null!=d.secondary.delay?d.secondary.delay:.1*a;c.to(e.domElement,.3,{autoAlpha:1,delay:f,onStartParams:[e,d,this],onStart:this.addChildAsSecondary})}}this.secElementsAdded=!0}},d.prototype.addChildAsSecondary=function(a,c,d){c.position==b.FREE3D_P?d.free3DContainer.addChild(a):d.addChild(a)},d.prototype.removeSecondaryElements=function(){if(this.secElementsAdded){for(var a=0;a<this.secondaryElements.length;a++){var b=this.secondaryElements[a].element3d;b.getParent().removeChild(b)}this.secElementsAdded=!1}},d.prototype.show=function(a){this.isBuilt&&this.isHidden()&&(this.twFadeIn&&this.twFadeIn.isActive()||(this.twFadeOut&&this.twFadeOut.pause(),this.twFadeIn=c.to(this.domElement,.5,{delay:a,autoAlpha:1})),this.free3DContainer&&c.to(this.free3DContainer.domElement,.5,{delay:a,autoAlpha:1}))},d.prototype.hide=function(a){this.isBuilt&&!this.isHidden()&&(this.pauseVideo(),this.removeVideo(),this.removeSecondaryElements(),this.twFadeOut&&this.twFadeOut.isActive()||(this.twFadeOut=c.to(this.domElement,.3,{delay:a,autoAlpha:0,ease:Linear.easeNone})),this.free3DContainer&&c.to(this.free3DContainer.domElement,.3,{delay:a,autoAlpha:0,ease:Linear.easeNone}))},d.prototype.getSections=function(){return this.sectionsList},d.prototype.getFree3dContainer=function(){if(null===this.free3DContainer){var b=this.pageInfo.free3DContainer;this.free3DContainer=(new a).setId(this.getId()+"-externalContainer").setPosition(b.x,b.y,b.z).setRotation(b.rotationX,b.rotationY,b.rotationZ),null!=b.scale&&this.free3DContainer.setScale(b.scale,b.scale,b.scale),this.free3DContainer.update(),this.free3DContainer.setCSS("opacity","0"),this.free3DContainer.setCSS("visibility","hidden"),this.parentSprite3D.addChild(this.free3DContainer)}return this.free3DContainer},d.prototype.addFree3dElement=function(){if(this.elementList)for(var a=0;a<this.elementList.length;a++)this.elementList[a].info.position==b.FREE3D_P&&(this.elementList[a].info.secondary||this.getFree3dContainer().addChild(this.elementList[a].element3d))},d.prototype.getFree3DContainer=function(){return this.free3DContainer},d.prototype.setParentSprite=function(a){this.parentSprite3D=a,this.addFree3dElement()},d.prototype.convertElement=function(b){var c=new a;return c.addDomElement(b),c},d.prototype.createElement=function(b,c,d){var e=new a;return d.src?e.addDomElement(this.pageInfo[d.src]):e.setInnerHTML(d.html),e},d});