define(["jquery","TweenMax","Modernizr","crossroads","hasher","app/overlay"],function(a,b,c,d,e,f){var g=0,h="reel/",i="reel",j="folio",k="",l="",m={},n=!1,o="http://flash.turbodrive.tv/",p="http://m.turbodrive.tv/",q=!1;CONFIG.debug;var r,s,t=function(){c.addTest("ipad",function(){return!!navigator.userAgent.match(/iPad/i)}),c.addTest("iphone",function(){return!!navigator.userAgent.match(/iPhone/i)}),c.addTest("ipod",function(){return!!navigator.userAgent.match(/iPod/i)}),c.addTest("android",function(){return!!navigator.userAgent.match(/android/i)}),c.addTest("ieMobile",function(){return!!navigator.userAgent.match(/IEMobile/i)}),c.addTest("ie",function(){return!!navigator.userAgent.match(/MSIE/i)}),c.addTest("ie2",function(){return!!navigator.userAgent.match(/Trident/i)}),c.addTest("appleios",function(){return c.ipad||c.ipod||c.iphone}),c.addTest("mobile",function(){return c.appleios||c.android||c.ieMobile}),q&&(!c.video||c.ie||c.ie2?(alert("redirect to flash version"),window.location.href=o):c.mobile&&window.outerHeight<1e3&&window.outerWidth<1e3?(alert("redirect to mobile version"),window.location.href=p):alert("no redirect - stay on html5 version")),c.addTest("highresdisplay",function(){if(window.matchMedia){var a=window.matchMedia("only screen and (-moz-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen  and (min-device-pixel-ratio: 1.3), only screen and (min-resolution: 1.3dppx)");if(a&&a.matches)return!0}}),c.addTest("firefox",function(){return navigator.userAgent.toLowerCase().indexOf("firefox")>-1}),c.addTest("chrome36",function(){return-1==navigator.userAgent.toLowerCase().indexOf("chrome")?!1:parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1],10)>35}),c.addTest("ios7",function(){return!!navigator.userAgent.match(/OS 7_\d/i)}),CONFIG.isRetina=c.highresdisplay,CONFIG.isiOs=c.appleios,CONFIG.isMobile=c.mobile,CONFIG.isFirefox=c.firefox,CONFIG.isChrome36=c.chrome36,d.addRoute("/{env}/{page}/",z),d.addRoute("/{env}/{page}/{section}/",y),document.ontouchmove=function(a){a.preventDefault()},f.on.clickMainOverlay.add(w),a(window).resize(db),db(null),f.loadGmd(),f.on.gmdLoaded.add(u)},u=function(){f.on.gmdLoaded.remove(u),eb?v():s=v},v=function(){s=null,e.initialized.add(x),e.changed.add(x),e.init()},w=function(){if(m.header&&m.header.isOpen())m.header.close();else if(m.reel){var a=m.reel.getCurrentChapter();a&&(a.link?window.location.hash=a.link:CONFIG.debug&&a.debugLink&&(window.location.hash=a.debugLink))}},x=function(a){""==a&&e.setHash(h),"reel/"==a&&(a="reel/preintro/"),"folio/"==a&&e.setHash("folio","ikaf2/"),d.parse(a)},y=function(a,b,c){z(a,b,c)},z=function(b,c,d){var e=b==j;if(m.header&&m.header.close(),k==b){if(c==l){if(!d)return;E(c,d)}e?E(c,d):m.reel.seekToChapter(c,!0)}else""==k?e?(a("#reel").css("visibility","hidden"),f.show(f.LOADER),E(c,d)):(D(),N(c)):e?(m.reel.pause(),f.show(f.MINI_LOADER,.6),E(c,d)):N(c,A);l=c,k=b},A=function(){m.reel.on.readyToPlayAfterSeek.remove(A),m.reel.on.transitionComplete.add(B),m.reel.startTransition(!1),m.reel.resume(),W(!0)},B=function(){m.reel.on.transitionComplete.remove(B),m.folio.kill()},C=function(){m.header.updateState(l,m.folio.pageIsProject(l)),m.header.on.initialized.remove(C),m.reel&&m.reel.sleep()},D=function(){a("#folioContent").css("visibility","hidden")},E=function(b,c,d){m.folio?(d&&m.folio.on.readyForIntroTransition.add(d),m.folio.on.pageLoaded.add(L),m.folio.load(b,c)):(a("body").addClass("texture-background"),require(["app/folio"],function(a){m.folio=a,m.folio.on.initialized.add(J),d&&m.folio.on.readyForIntroTransition.add(d),m.folio.on.twPositionDefined.add(K),m.folio.on.creationProgress.add(f.updateProgress),m.folio.on.creationComplete.add(I),m.folio.on.pageCreationComplete.add(H),m.folio.on.pageLoading.add(G),m.folio.on.hireMeClicked.add(F),m.folio.init(b,c)}))},F=function(){m.header.openHireMe()},G=function(){m.folio.on.pageLoading.remove(G),f.show(f.MINI_LOADER,0)},H=function(){m.folio.on.pageCreationComplete.remove(H),f.hide(f.MINI_LOADER)},I=function(){m.folio.on.creationComplete.remove(I),m.folio.on.creationProgress.remove(f.updateProgress),f.disable()},J=function(a,b){m.folio.on.initialized.remove(J),m.folio.on.pageLoaded.add(L),m.folio.load(a,b)},K=function(a,b){m.header&&m.header.updateState(a,m.folio.pageIsProject(l)),b?e.setHash("folio",a+"/"+b+"/"):e.setHash("folio",a+"/")},L=function(a,b){$(),m.folio.on.pageLoaded.remove(L),m.folio.hasCurrentPage3D()?m.folio.startTransition(a,b):(m.folio.on.readyForIntroTransition.add(M),m.folio.startIntroTransition(a,b))},M=function(a,b){if(m.folio.wakeup(a),f.disable(),m.folio.startTransition(a,b),m.reel&&(m.reel.sleep(),m.reel.startTransition(!0)),m.header)setTimeout(W,500,!1);else{var c=CONFIG.hyperDriveTransition?8e3:500;setTimeout(W,c,!1,C)}},N=function(a,b){if(f.loadGmd(),Z(),m.header&&m.header.updateState("reel",!1),m.reel){if(!a||!b)throw new Error("no chapter or handlerFunction defined");m.reel.on.readyToPlayAfterSeek.add(b),m.reel.wakeup(a)}else require(["app/reelPlayer"],function(c){m.reel=c,m.reel.on.playStarted.add(R),m.reel.on.showHeader.add(S),m.reel.on.playGmd.add(T),m.reel.on.hideGmd.add(U),m.reel.on.enableOverlayClicks.add(f.enableClicks),m.reel.on.highlightButtonsHeader.add(O),m.reel.on.bufferFull.add(f.onBufferFull),m.reel.on.bufferEmpty.add(f.onBufferEmpty),m.reel.on.bufferProgress.add(f.onBufferProgress),m.reel.on.videoComplete.add(V),m.reel.on.changeChapter.add(P),b&&m.reel.on.readyToPlayAfterSeek.add(b),m.reel.init(a),CONFIG.isMobile&&m.reel.on.mobileCTAReady.add(Q)})},O=function(){m.header&&m.header.highlightButtons()},P=function(a){e.setHash("reel",a.id+"/")},Q=function(){m.reel.on.mobileCTAReady.remove(Q),f.hide()},R=function(){m.reel.on.playStarted.remove(R),f.hide()},S=function(){W(!0)},T=function(){f.show(f.GETMOREDETAILS)},U=function(a){f.hide(f.GETMOREDETAILS,a)},V=function(){e.setHash("folio","about/")},W=function(a,b){m.header?m.header.show(a):require(["app/header"],function(c){m.header=c,m.header.on.close.add(X),b&&m.header.on.initialized.add(b),m.header.on.open.add(Y),m.header.init(),m.header.show(a)})},X=function(){m.reel&&m.reel.isActive()&&m.reel.resume(),f.gmdLoaded()&&f.resumeGmd()},Y=function(){m.reel&&m.reel.isActive()&&m.reel.pause(),f.gmdLoaded()&&f.pauseGmd()},Z=function(){document.removeEventListener("touchstart",ab,!1),document.removeEventListener("touchmove",bb,!1),document.removeEventListener("touchend",cb,!1),n=!1},$=function(){n||(document.addEventListener("touchstart",ab,!1),document.addEventListener("touchmove",bb,!1),document.addEventListener("touchend",cb,!1),n=!0)},_=function(b){if(a(b).is("a")){var c=a(b).attr("href"),d=a(b).attr("target");if("#"!=c)return d&&"_self"!=d?(window.open(c,d),!0):(0==c.indexOf("#/")?(c=c.slice(2),e.setHash(c)):window.open(c,d),!0)}return!1},ab=function(a){a.preventDefault(),r=a.target,m.folio&&m.folio.onTouchStart(a),m.header&&m.header.close()},bb=function(a){a.preventDefault(),m.folio&&m.folio.onTouchMove(a)},cb=function(a){a.preventDefault();var b=a.target;m.folio&&m.folio.onTouchEnd(a),b==r&&(_(b)||(m.header&&m.header.onTouchClick(b),m.folio&&m.folio.onTouchClick(b))),r=null},db=function(){fb(),LAYOUT.viewportH=window.innerHeight,LAYOUT.viewportW=window.innerWidth,LAYOUT.vH2=.5*LAYOUT.viewportH,LAYOUT.vW2=.5*LAYOUT.viewportW,LAYOUT.ratioH=LAYOUT.getRatioH(LAYOUT.viewportH),LAYOUT.ratioW=LAYOUT.getRatioW(LAYOUT.viewportW),LAYOUT._rX=LAYOUT.initW/LAYOUT.viewportW,LAYOUT._rY=LAYOUT.initH/LAYOUT.viewportH;var c=LAYOUT.viewportH/LAYOUT.viewportW*35.13+20,d=c*Math.PI/180;LAYOUT_3D.PX_PERFECT_DISTANCE=-(LAYOUT.viewportH/2)/Math.tan(d/2),LAYOUT_3D.fovMult001=(LAYOUT_3D.PX_PERFECT_DISTANCE+526)/-966,m.header&&m.header.resize(),m.reel&&m.reel.resize(),m.folio&&m.folio.resize(),LAYOUT.currentEnv==j&&b.set(a(i),{y:-g-200}),a(i).css("height",g)},eb=!0,fb=function(){if(CONFIG.isMobile){var b=a(window).width()>a(window).height();eb&&!b?(f.show(f.LANDSCAPE_ALERT),m.reel&&m.reel.isActive()&&m.reel.pause()):!eb&&b&&(f.hide(f.LANDSCAPE_ALERT),s&&s(),m.reel&&m.reel.isActive()&&m.reel.resume()),eb=b}};t()});